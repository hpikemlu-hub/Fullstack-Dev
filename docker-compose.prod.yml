# Production Docker Compose Override for MySQL Deployment
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

version: '3.8'

services:
  app:
    environment:
      NODE_ENV: production
      DB_TYPE: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: workload_db
      DB_USER: workload_user
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_CONNECTION_LIMIT: 20
      DB_CONNECTION_TIMEOUT: 60000
      DB_ACQUIRE_TIMEOUT: 60000
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN}
      MYSQL_FALLBACK_TO_SQLITE: false
      MIGRATE_TO_MYSQL: true
      RUN_MIGRATIONS: true
      RUN_SEED: true
      RESET_ADMIN: false
    volumes:
      - app_data:/app/data
      - app_logs:/app/logs
      - app_uploads:/app/uploads
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mysql:
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: workload_db
      MYSQL_USER: workload_user
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init-mysql.sql:/docker-entrypoint-initdb.d/init-mysql.sql:ro
      - mysql_logs:/var/log/mysql
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    command: >
      --default-authentication-plugin=mysql_native_password
      --innodb-buffer-pool-size=256M
      --max-connections=100
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  mysql_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MYSQL_DATA_PATH:-./data/mysql}
  mysql_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MYSQL_LOGS_PATH:-./logs/mysql}
  app_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${APP_DATA_PATH:-./data/app}
  app_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${APP_LOGS_PATH:-./logs/app}
  app_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${APP_UPLOADS_PATH:-./data/uploads}